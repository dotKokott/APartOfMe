<html>
  <head>
    <link href="./css/style.css" rel="stylesheet" type="text/css">
  </head>
  <body>
    <script src="https://code.jquery.com/jquery-3.1.1.min.js" integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin="anonymous"></script>

    <script src="./ext_js/utils.js"></script>
		<script src="./ext_js/jsfeat-min.js"></script>
		<script src="./ext_js/frontalface.js"></script>
		<script src="./ext_js/jsfeat_detect.js"></script>
		<script src="./ext_js/numeric-1.2.6.min.js"></script>
		<script src="./ext_js/mosse.js"></script>
		<script src="./ext_js/left_eye_filter.js"></script>
		<script src="./ext_js/right_eye_filter.js"></script>
		<script src="./ext_js/nose_filter.js"></script>
		<script src="./models/model_pca_20_svm.js"></script>
		<script src="./js/clm.js"></script>
		<script src="./js/svmfilter_webgl.js"></script>
		<script src="./js/svmfilter_fft.js"></script>
		<script src="./js/mossefilter.js"></script>
    <script src="./js/face_deformer.js"></script>
    <script src="./js/poisson_new.js"></script>
		<script src="./ext_js/Stats.js"></script>

    <script src="./js/clmtrackr.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>

    <div id="container">
      <video id="videoel" width="400" height="300" preload="auto" loop>
      </video>
      <canvas id="overlay" width="400" height="300"></canvas>
      <canvas id="webgl" width="400" height="300"></canvas>
    </div>
    <br/>

    <script>
      var vid = document.getElementById('videoel');
      var overlay = document.getElementById('overlay');
      var overlayCC = overlay.getContext('2d');

      var ctrack = new clm.tracker({useWebGL : true});
      ctrack.init(pModel);

      var webGLContext;
      var webGLTestCanvas = document.createElement('canvas');
      if (window.WebGLRenderingContext) {
        webGLContext = webGLTestCanvas.getContext('webgl') || webGLTestCanvas.getContext('experimental-webgl');
        if (!webGLContext || !webGLContext.getExtension('OES_texture_float')) {
          webGLContext = null;
        }
      }
      if (webGLContext == null) {
        alert("Your browser does not seem to support WebGL. Unfortunately this face mask example depends on WebGL, so you'll have to try it in another browser. :(");
      }

      navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia;
      window.URL = window.URL || window.webkitURL || window.msURL || window.mozURL;

      // check for camerasupport
      if (navigator.getUserMedia) {
          var videoSelector = {video : true};
          if (window.navigator.appVersion.match(/Chrome\/(.*?) /)) {
            var chromeVersion = parseInt(window.navigator.appVersion.match(/Chrome\/(\d+)\./)[1], 10);
            if (chromeVersion < 20) {
              videoSelector = "video";
            }
          };

          navigator.getUserMedia(videoSelector, function( stream ) {
            if (vid.mozCaptureStream) {
              vid.mozSrcObject = stream;
            } else {
              vid.src = (window.URL && window.URL.createObjectURL(stream)) || stream;
            }
            vid.play();
          }, function() { alert('no video')});
        }

        function startVideo() {
          overlay.width = vid.width;
          overlay.height = vid.height;
					// start video
					vid.play();
					// start tracking
					ctrack.start(vid);
					// start loop to draw face
					drawGridLoop();
				}

        var fd = new faceDeformer();
				fd.init(document.getElementById('webgl'));
				var wc1 = document.getElementById('webgl').getContext('webgl') || document.getElementById('webgl').getContext('experimental-webgl')
				wc1.clearColor(0,0,0,0);

				// canvas for copying the warped face to
				var newcanvas = document.createElement('CANVAS');
				newcanvas.width = vid.width;
				newcanvas.height = vid.height;
				// canvas for copying videoframes to
				var videocanvas = document.createElement('CANVAS');
				videocanvas.width = vid.width;
				videocanvas.height = vid.height;

				var mouth_vertices = [
				  [44,45,61,44],
				  [45,46,61,45],
				  [46,60,61,46],
				  [46,47,60,46],
				  [47,48,60,47],
				  [48,59,60,48],
				  [48,49,59,48],
				  [49,50,59,49],
				  [50,51,58,50],
				  [51,52,58,51],
				  [52,57,58,52],
				  [52,53,57,52],
				  [53,54,57,53],
				  [54,56,57,54],
				  [54,55,56,54],
				  [55,44,56,55],
				  [44,61,56,44],
				  [61,60,56,61],
				  [56,57,60,56],
				  [57,59,60,57],
				  [57,58,59,57],
				  [50,58,59,50],
				];

				var extendVertices = [
				  [0,71,72,0],
				  [0,72,1,0],
				  [1,72,73,1],
				  [1,73,2,1],
				  [2,73,74,2],
				  [2,74,3,2],
				  [3,74,75,3],
				  [3,75,4,3],
				  [4,75,76,4],
				  [4,76,5,4],
				  [5,76,77,5],
				  [5,77,6,5],
				  [6,77,78,6],
				  [6,78,7,6],
				  [7,78,79,7],
				  [7,79,8,7],
				  [8,79,80,8],
				  [8,80,9,8],
				  [9,80,81,9],
				  [9,81,10,9],
				  [10,81,82,10],
				  [10,82,11,10],
				  [11,82,83,11],
				  [11,83,12,11],
				  [12,83,84,12],
				  [12,84,13,12],
				  [13,84,85,13],
				  [13,85,14,13],
				  [14,85,86,14],
				  [14,86,15,14],
				  [15,86,87,15],
				  [15,87,16,15],
				  [16,87,88,16],
				  [16,88,17,16],
				  [17,88,89,17],
				  [17,89,18,17],
				  [18,89,93,18],
				  [18,93,22,18],
				  [22,93,21,22],
				  [93,92,21,93],
				  [21,92,20,21],
				  [92,91,20,92],
				  [20,91,19,20],
				  [91,90,19,91],
				  [19,90,71,19],
				  [19,71,0,19]
				]

        function drawGridLoop() {
					// get position of face
					positions = ctrack.getCurrentPosition(vid);

					overlayCC.clearRect(0, 0, 500, 375);
					if (positions) {
						// draw current grid
						ctrack.draw(overlay);
					}
					// check whether mask has converged
					var pn = ctrack.getConvergence();

					if (pn < 0.1) {
						drawMaskLoop();
					} else {
						requestAnimFrame(drawGridLoop);
					}
				}

				function drawMaskLoop() {
					videocanvas.getContext('2d').drawImage(vid,0,0,videocanvas.width,videocanvas.height);

					var pos = ctrack.getCurrentPosition(vid);

          if(pos[0] === undefined) {
            animationRequest = requestAnimFrame(drawGridLoop);
            return;
          }
					// create additional points around face
					var tempPos;
					var addPos = [];
					for (var i = 0;i < 23;i++) {
						tempPos = [];
						tempPos[0] = (pos[i][0] - pos[62][0])*1.3 + pos[62][0];
						tempPos[1] = (pos[i][1] - pos[62][1])*1.3 + pos[62][1];
						addPos.push(tempPos);
					}
					// merge with pos
					var newPos = pos.concat(addPos);

					var newVertices = pModel.path.vertices.concat(mouth_vertices);
					// merge with newVertices
					newVertices = newVertices.concat(extendVertices);

					fd.load(videocanvas, newPos, pModel, newVertices);

					var parameters = ctrack.getCurrentParameters();
					for (var i = 6;i < parameters.length;i++) {
						parameters[i] += ph['component '+(i-3)];
					}
					positions = ctrack.calculatePositions(parameters);

					overlayCC.clearRect(0, 0, 400, 300);
					if (positions) {
						// add positions from extended boundary, unmodified
						newPos = positions.concat(addPos);
						// draw mask on top of face
						fd.draw(newPos);
					}
					animationRequest = requestAnimFrame(drawMaskLoop);
				}

        var pnums = pModel.shapeModel.eigenValues.length-2;
				var parameterHolder = function() {
					for (var i = 0;i < pnums;i++) {
						this['component '+(i+3)] = 0;
					}
					this.presets = 0;
				};

				var ph = new parameterHolder();

				var presets = {
					"unwell" : [0, 0, 0, 0, 0, 0, 22, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
					"inca" : [0, 0, -9, 0, -11, 0, 0, 0, 0, 0, 0, 0, 12, 0, 0, 0, 0, 0],
					"cheery" : [0, 0, -9, 9, -11, 0, 0, 0, 0, 0, 0, 0, -9, 0, 0, 0, 0, 0],
					"dopey" : [0, 0, 0, 0, 0, 0, 0, -11, 0, 0, 0, 0, 0, 0, 20, 0, 0, 0],
					"longface" : [0, 0, 0, 0, -15, 0, 0, -12, 0, 0, 0, 0, 0, 0, -7, 0, 0, 5],
					"lucky" : [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, -4, 0, -6, 12, 0, 0],
					"overcute" : [0, 0, 0, 0, 16, 0, -14, 0, 0, 0, 0, 0, -7, 0, 0, 0, 0, 0],
					"aloof" : [0, 0, 0, 0, 0, 0, 0, -8, 0, 0, 0, 0, 0, 0, -2, 0, 0, 10],
					"evil" : [0, 0, 0, 0, 0, 0, 0, 0, 6, 0, 0, 0, 0, 0, 0, 0, 0, -8],
					"artificial" : [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 11, 0, -16, 0, 0, 0, 0, 0],
					"none" : [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
				};

				var control = {};
				var eig = 0;
				for (var i = 0;i < pnums;i++) {
					eig = Math.sqrt(pModel.shapeModel.eigenValues[i+2])*3
					//control['c'+(i+3)] = gui.add(ph, 'component '+(i+3), -5*eig, 5*eig).listen();
				}

				//for (var i = 0;i < pnums;i++) {
				//	ph['component '+(i+3)] = presets['unwell'][i];
				//}

      function map_range (value, low1, high1, low2, high2) {
        return low2 + (high2 - low2) * (value - low1) / (high1 - low1);
      }

      var socket = io();
      socket.on('knob', function(msg) {
        var split = msg.split(":");
        var comp = parseInt(split[0]) + 15;
        var val = parseInt(split[1]);

        var eig = Math.sqrt(pModel.shapeModel.eigenValues[comp+2])*3;

        var min = -5 * eig;
        var max = 5 * eig;

        var value = map_range(val, 0, 1023, min, max);

        ph['component ' + (comp + 3)] = value;
      });
    </script>
  </body>
</html>
